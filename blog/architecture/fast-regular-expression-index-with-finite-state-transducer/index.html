<!doctype html><html lang=en><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Fast regular expression index with finite state transducer</title>
<link rel=icon href="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAwIDUwMCIgd2lkdGg9IjUwMCIgaGVpZ2h0PSI1MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Yng9Imh0dHBzOi8vYm94eS1zdmcuY29tIj4KICA8cGF0aCBkPSJNIDE2NC4yMDYgMjQ5Ljc5MyBtIC00MS45NDMgMCBhIDQxLjk0MyA0MS45NDMgMCAxIDAgODMuODg2IDAgYSA0MS45NDMgNDEuOTQzIDAgMSAwIC04My44ODYgMCBaIE0gMTY0LjIwNiAyNDkuNzkzIG0gLTI1LjE2NiAwIGEgMjUuMTY2IDI1LjE2NiAwIDAgMSA1MC4zMzIgMCBhIDI1LjE2NiAyNS4xNjYgMCAwIDEgLTUwLjMzMiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjI1NjIzNCwgMC45NjY2MTUsIC0wLjk2NjYxNSwgMC4yNTYyMzQsIDI1MS44NzEwNjMsIDE3MS45NjA4NjEpIiBieDpzaGFwZT0icmluZyAxNjQuMjA2IDI0OS43OTMgMjUuMTY2IDI1LjE2NiA0MS45NDMgNDEuOTQzIDFAZGQ3ODBlYzciLz4KICA8cGF0aCBkPSJNIDE5OS4xMTggMjI3LjY2NCBtIC0xMDEuMzg2IDAgYSAxMDEuMzg2IDEwMS4zODYgMCAxIDAgMjAyLjc3MiAwIGEgMTAxLjM4NiAxMDEuMzg2IDAgMSAwIC0yMDIuNzcyIDAgWiBNIDE5OS4xMTggMjI3LjY2NCBtIC02MC44MzEgMCBhIDYwLjgzMSA2MC44MzEgMCAwIDEgMTIxLjY2MiAwIGEgNjAuODMxIDYwLjgzMSAwIDAgMSAtMTIxLjY2MiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjkzNjQ5LCAwLjM1MDY5NSwgLTAuMzUwNjk1LCAwLjkzNjQ5LCA0MS4yMzc0MzQsIDUxLjIwMDEyNykiIGJ4OnNoYXBlPSJyaW5nIDE5OS4xMTggMjI3LjY2NCA2MC44MzEgNjAuODMxIDEwMS4zODYgMTAxLjM4NiAxQGRiZDI0ZjEyIi8+CiAgPHBhdGggZD0iTSAyMzguNDIxIDE4Mi40NjUgbSAtOTcuNDU4IDAgYSA5Ny40NTggOTcuNDU4IDAgMSAwIDE5NC45MTYgMCBhIDk3LjQ1OCA5Ny40NTggMCAxIDAgLTE5NC45MTYgMCBaIE0gMjM4LjQyMSAxODIuNDY1IG0gLTU4LjQ3MyAwIGEgNTguNDczIDU4LjQ3MyAwIDAgMSAxMTYuOTQ2IDAgYSA1OC40NzMgNTguNDczIDAgMCAxIC0xMTYuOTQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KDAuNzczNjA0LCAwLjYzMzY3LCAtMC42MzM2NywgMC43NzM2MDQsIDE4Ni40MTk0NjQsIC04MS40Nzk2ODMpIiBieDpzaGFwZT0icmluZyAyMzguNDIxIDE4Mi40NjUgNTguNDczIDU4LjQ3MyA5Ny40NTggOTcuNDU4IDFAM2ZkMjA3YzkiLz4KICA8cGF0aCBkPSJNIDI3Mi45NjQgMTk5LjAzMSBtIC0xMDAuMzgxIDAgYSAxMDAuMzgxIDEwMC4zODEgMCAxIDAgMjAwLjc2MiAwIGEgMTAwLjM4MSAxMDAuMzgxIDAgMSAwIC0yMDAuNzYyIDAgWiBNIDI3Mi45NjQgMTk5LjAzMSBtIC02MC4yMyAwIGEgNjAuMjMgNjAuMjMgMCAwIDEgMTIwLjQ2IDAgYSA2MC4yMyA2MC4yMyAwIDAgMSAtMTIwLjQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KC0wLjk5MzU3OSwgMC4xMTMxNDQsIC0wLjExMzE0NCwgLTAuOTkzNTc5LCA2NDMuMzM2MzY1LCA0MjIuODc4ODQ1KSIgYng6c2hhcGU9InJpbmcgMjcyLjk2NCAxOTkuMDMxIDYwLjIzIDYwLjIzIDEwMC4zODEgMTAwLjM4MSAxQDU2N2I5YzJjIi8+Cjwvc3ZnPg=="><style>html:not([data-theme=dark]){--bg-grad:rgba(255, 255, 255, 0) 0%, #fff 25%, #fff 75%, rgba(255, 255, 255, 0) 100%;--bg:#fff;--dark:none;--fg-on:#000;--fg:#222;--lite:block;--menu-bg:#fff;--menu-fg:#222;--menu-a:0.25;--pre-dim:#777;--pre-val:#870;--pre:#222;--svg:#444;--td:#ddd;--tr:#f7f7f7;--warn-info:#222;--border:#FFCF00}html[data-theme=dark]{color-scheme:dark;--bg-grad:rgba(25, 25, 25, 0) 0%, #191919 25%, #191919 75%, rgba(25, 25, 25, 0) 100%;--bg:#191919;--dark:block;--fg-on:#ddd;--fg:#aaa;--lite:none;--menu-bg:#222;--menu-fg:#aaa;--menu-a:0.65;--pre-dim:#999;--pre-val:#cb8;--pre:#ccc;--svg:#aaa;--td:#333;--tr:#151515;--warn-info:#ddd}@media(prefers-color-scheme:dark){html:not([data-theme=light]){color-scheme:dark;--bg-grad:rgba(25, 25, 25, 0) 0%, #191919 25%, #191919 75%, rgba(25, 25, 25, 0) 100%;--bg:#191919;--dark:block;--fg-on:#ddd;--fg:#aaa;--lite:none;--menu-bg:#222;--menu-fg:#aaa;--menu-a:0.65;--pre-dim:#999;--pre-val:#cb8;--pre:#ccc;--svg:#aaa;--td:#333;--tr:#151515;--warn-info:#ddd}}body{font:16px/140% sans-serif}a{color:inherit}b,strong{color:var(--fg-on)}footer{font-size:80%;line-height:140%;font-style:italic}sup{vertical-align:top;font-size:70%;line-height:100%;font-style:normal}footer>sup[id]{position:relative;padding-top:20px}code{font-family:noto sans mono,monospace;background:rgba(159,159,159,.15);padding:1px 4px;margin:-1px 0;border-radius:5px;white-space:pre}.dl{display:block;width:22px;height:22px}.dl:after{content:'';display:block;width:22px;height:22px;mask-repeat:no-repeat;mask-position:center;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center}@-moz-document url-prefix(){code{white-space:pre-wrap}}@keyframes scale-bar{0%{transform:scale(1e-7,1)}100%{transform:scale(1,1)}}.logo{display:inline-block;font-size:200%;font-weight:700;margin-top:10px;margin-bottom:10px;line-height:40px;padding-left:50px;background-image:url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAwIDUwMCIgd2lkdGg9IjUwMCIgaGVpZ2h0PSI1MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Yng9Imh0dHBzOi8vYm94eS1zdmcuY29tIj4KICA8cGF0aCBkPSJNIDE2NC4yMDYgMjQ5Ljc5MyBtIC00MS45NDMgMCBhIDQxLjk0MyA0MS45NDMgMCAxIDAgODMuODg2IDAgYSA0MS45NDMgNDEuOTQzIDAgMSAwIC04My44ODYgMCBaIE0gMTY0LjIwNiAyNDkuNzkzIG0gLTI1LjE2NiAwIGEgMjUuMTY2IDI1LjE2NiAwIDAgMSA1MC4zMzIgMCBhIDI1LjE2NiAyNS4xNjYgMCAwIDEgLTUwLjMzMiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjI1NjIzNCwgMC45NjY2MTUsIC0wLjk2NjYxNSwgMC4yNTYyMzQsIDI1MS44NzEwNjMsIDE3MS45NjA4NjEpIiBieDpzaGFwZT0icmluZyAxNjQuMjA2IDI0OS43OTMgMjUuMTY2IDI1LjE2NiA0MS45NDMgNDEuOTQzIDFAZGQ3ODBlYzciLz4KICA8cGF0aCBkPSJNIDE5OS4xMTggMjI3LjY2NCBtIC0xMDEuMzg2IDAgYSAxMDEuMzg2IDEwMS4zODYgMCAxIDAgMjAyLjc3MiAwIGEgMTAxLjM4NiAxMDEuMzg2IDAgMSAwIC0yMDIuNzcyIDAgWiBNIDE5OS4xMTggMjI3LjY2NCBtIC02MC44MzEgMCBhIDYwLjgzMSA2MC44MzEgMCAwIDEgMTIxLjY2MiAwIGEgNjAuODMxIDYwLjgzMSAwIDAgMSAtMTIxLjY2MiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjkzNjQ5LCAwLjM1MDY5NSwgLTAuMzUwNjk1LCAwLjkzNjQ5LCA0MS4yMzc0MzQsIDUxLjIwMDEyNykiIGJ4OnNoYXBlPSJyaW5nIDE5OS4xMTggMjI3LjY2NCA2MC44MzEgNjAuODMxIDEwMS4zODYgMTAxLjM4NiAxQGRiZDI0ZjEyIi8+CiAgPHBhdGggZD0iTSAyMzguNDIxIDE4Mi40NjUgbSAtOTcuNDU4IDAgYSA5Ny40NTggOTcuNDU4IDAgMSAwIDE5NC45MTYgMCBhIDk3LjQ1OCA5Ny40NTggMCAxIDAgLTE5NC45MTYgMCBaIE0gMjM4LjQyMSAxODIuNDY1IG0gLTU4LjQ3MyAwIGEgNTguNDczIDU4LjQ3MyAwIDAgMSAxMTYuOTQ2IDAgYSA1OC40NzMgNTguNDczIDAgMCAxIC0xMTYuOTQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KDAuNzczNjA0LCAwLjYzMzY3LCAtMC42MzM2NywgMC43NzM2MDQsIDE4Ni40MTk0NjQsIC04MS40Nzk2ODMpIiBieDpzaGFwZT0icmluZyAyMzguNDIxIDE4Mi40NjUgNTguNDczIDU4LjQ3MyA5Ny40NTggOTcuNDU4IDFAM2ZkMjA3YzkiLz4KICA8cGF0aCBkPSJNIDI3Mi45NjQgMTk5LjAzMSBtIC0xMDAuMzgxIDAgYSAxMDAuMzgxIDEwMC4zODEgMCAxIDAgMjAwLjc2MiAwIGEgMTAwLjM4MSAxMDAuMzgxIDAgMSAwIC0yMDAuNzYyIDAgWiBNIDI3Mi45NjQgMTk5LjAzMSBtIC02MC4yMyAwIGEgNjAuMjMgNjAuMjMgMCAwIDEgMTIwLjQ2IDAgYSA2MC4yMyA2MC4yMyAwIDAgMSAtMTIwLjQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KC0wLjk5MzU3OSwgMC4xMTMxNDQsIC0wLjExMzE0NCwgLTAuOTkzNTc5LCA2NDMuMzM2MzY1LCA0MjIuODc4ODQ1KSIgYng6c2hhcGU9InJpbmcgMjcyLjk2NCAxOTkuMDMxIDYwLjIzIDYwLjIzIDEwMC4zODEgMTAwLjM4MSAxQDU2N2I5YzJjIi8+Cjwvc3ZnPg==);background-repeat:no-repeat;background-size:40px 40px}nav a{text-decoration:none}nav a:hover{text-decoration:underline}nav ul{margin:0;padding:0}nav li{list-style:none}#menu>ul>li{padding-top:20px}nav li.current{font-weight:700}nav ul.h2{padding-left:10px;font-size:80%;line-height:150%}nav ul.h3{padding:0 0 0 10px}nav li.current>ul.h3{font-weight:400}#icons a{display:inline-block}body:not(.has-js) #theme{display:none}.index h1{text-align:center}.blog-logo img{width:60px;height:60px}.index blockquote{text-align:center;font-style:italic;margin:0 0 100px}.bench a{text-decoration:none}.bench a:hover{text-decoration:underline}figure{margin:60px auto}figcaption{font-weight:700;text-align:center;margin:40px 0 -40px}figure+figcaption{font-weight:400;text-align:left;margin:-40px auto 60px;font-size:13px;line-height:140%;font-style:italic;max-width:800px;padding:0 15%;box-sizing:border-box}.author{font-family:monospace}h1{margin:10px 0 20px;font-size:200%;line-height:40px}h2{font-size:160%;border-bottom:2px solid #ffcf00;padding-top:63px;line-height:40px}h3{font-size:140%;padding-top:67px;line-height:32px}h4{font-size:100%;padding-top:70px;line-height:26px}h2,h3,h4{position:relative;margin:-10px 0 20px}h2 .permalink,h3 .permalink,h4 .permalink{position:absolute;width:25px;left:-25px;text-align:center;text-decoration:none;opacity:50%;user-select:none;-webkit-user-select:none}h2:not(:hover) .permalink:not(:focus),h3:not(:hover) .permalink:not(:focus),h4:not(:hover) .permalink:not(:focus){color:transparent}p{margin:20px 0}.warning{border:1px solid #a90;border-radius:10px;padding:20px 20px 20px 50px;background-color:rgba(255,223,0,.2)}.warning:before{content:'!';font:700 43px/43px serif;margin-left:-30px;display:block;float:left}.info{border:1px solid var(--fg-on);border-radius:10px;padding:20px 20px 20px 60px}.info:before{content:'â“˜';font:700 43px/43px serif;margin-left:-43px;display:block;float:left}table{font-size:inherit;margin:30px auto;border-collapse:collapse;display:block;width:max-content;max-width:100%;overflow-x:auto}td,th{padding:7px 10px;white-space:nowrap;vertical-align:top}pre{position:relative;font:14px/140% noto sans mono,monospace;background:rgba(127,127,127,.1);border:1px solid rgba(127,127,127,.5);border-radius:10px;padding:8px 10px;margin:30px 0;overflow-x:auto}pre:before{position:absolute;display:block;right:0;top:0;padding:5px 8px;font:12px/140% sans-serif}pre.cli3:before{content:'CLI'}pre.js3:before,pre.js2:before{content:'JS'}pre.go3:before,pre.go2:before{content:'Go'}pre.unix2:before{content:'Unix'}pre.windows2:before{content:'Windows'}.has-js pre.switchable{margin-top:0;display:none;border-top-right-radius:0}body[data-mode3=cli] pre.cli3,body[data-mode3=js] pre.js3,body[data-mode2=js] pre.js2,body[data-mode3=go] pre.go3,body[data-mode2=go] pre.go2,body[data-os2=unix] pre.unix2,body[data-os2=windows] pre.windows2{display:block}.has-js pre:before{display:none}.color-bold{font-weight:700;color:var(--fg-on)}.bg-red{background:#e24834}.color-red{color:#e24834}.bg-yellow{background:#f2d42d}.color-yellow{color:#f2d42d}.color-green{color:#58a549}.color-black{color:#000}.color-white{color:#fff}.color-dim{color:#777}.repl-in{margin-left:15px;display:block}.repl-in:before{position:absolute;display:block;left:10px;color:#7f7f7f}.cli1 .repl-in:before,.unix1 .repl-in:before,.cli2 .repl-in:before,.unix2 .repl-in:before,.cli3 .repl-in:before,.unix3 .repl-in:before{content:'$'}.windows1 .repl-in:before,.windows2 .repl-in:before,.windows3 .repl-in:before{content:'>'}.js1 .repl-in:before,.js2 .repl-in:before,.js3 .repl-in:before{content:'';display:block;width:16px;height:20px}.repl-out{color:#7f7f7f}.repl-in+.repl-in,.repl-out+.repl-in{margin-top:20px}blockquote{display:block;margin-block-start:1em;margin-block-end:1em;margin-inline-start:40px;margin-inline-end:40px;padding:0 1em;color:var(--fg);border-left:.25em solid var(--border)}.required{color:#ed8936;font-size:.7rem;font-weight:700;position:relative;bottom:4px}.optional{color:#718096;font-size:.7rem;font-weight:700;position:relative;bottom:4px}.markdown-body blockquote{padding:0 1em;color:var(--fgColor-muted,var(--color-fg-muted));border-left:.25em solid var(--borderColor-default,var(--color-border-default))}.switcher{display:none}.has-js .switcher{display:flex;justify-content:flex-end}.switcher a{background:rgba(127,127,127,.1);border:1px solid rgba(127,127,127,.5);border-bottom:none;border-right:none;text-decoration:none;user-select:none;-webkit-user-select:none;padding:5px 8px;font:12px/140% sans-serif}.switcher a:first-child{border-top-left-radius:10px}.switcher a:last-child{border-top-right-radius:10px;border-right:1px solid rgba(127,127,127,.5)}body[data-mode3=cli] .switcher .cli3,body[data-mode3=js] .switcher .js3,body[data-mode2=js] .switcher .js2,body[data-mode3=go] .switcher .go3,body[data-mode2=go] .switcher .go2,body[data-os2=unix] .switcher .unix2,body[data-os2=windows] .switcher .windows2{background:rgba(127,127,127,.25)}body{margin:0;padding:30px}nav{margin-bottom:50px}#menubar{display:none;position:fixed;left:-20px;top:0;right:-20px;height:50px;padding:0 20px;z-index:2}#menutoggle{display:block;width:50px;height:50px}body.has-js{padding-top:60px}.has-js #menubar{display:block}.has-js #shadow{position:fixed;left:0;top:0;right:0;bottom:0;z-index:3;background:0 0;visibility:hidden;transition:visibility .25s,background-color .25s}.has-js .open #shadow{background:rgba(0,0,0,.5);visibility:visible}.has-js #menu{position:fixed;left:0;top:0;bottom:0;width:220px;box-sizing:border-box;overflow-y:auto;padding:30px 0 0 30px;z-index:4;transition:transform .25s;transform:translateX(-220px);box-shadow:none}.has-js .open #menu{transform:translateX(0);box-shadow:0 0 20px rgba(0,0,0,.5)}#icons{position:static;margin:20px 0 20px 50px}.index h1{font-size:75px;line-height:40px}.index blockquote{font-size:16px}.available-options{margin-top:50px;display:flex;flex-flow:wrap;flex-direction:row}.option-group{padding-right:20px}.option-group ul{margin:0;padding:0 0 0 20px}@media(min-width:800px){body,body.has-js{position:relative;max-width:1e3px;margin:0 auto;padding:50px 50px 500px 250px}.index h1{font-size:100px;line-height:70px}.index blockquote{font-size:21px}main{position:relative;z-index:1}.has-js #menubar,.has-js #shadow{display:none}nav,.has-js nav{position:fixed;left:0;right:0;top:0;bottom:0;max-width:1300px;margin:0 auto;display:block}#menu,.has-js #menu,.has-js .open #menu{position:absolute;left:0;top:0;bottom:0;padding:50px 0 30px 30px;overflow-y:auto;transform:none;box-shadow:none}pre{margin-left:30px;margin-right:30px}li pre{margin-left:0;margin-right:0}.switcher{margin-right:30px}.available-options{justify-content:center}}body,#menu,nav ul ul{background:var(--bg);color:var(--fg)}#menubar{box-shadow:0 0 10px rgba(0,0,0,var(--menu-a));background:var(--menu-bg);color:var(--menu-fg)}.progress{background:linear-gradient(to right,var(--bg-grad))}path,rect,circle{fill:var(--svg);stroke:var(--svg)}h1,h2,h3,.logo,nav ul,nav li.current{color:var(--fg-on)}a:hover path,a:hover rect,a:hover circle{fill:var(--fg-on);stroke:var(--fg-on)}pre,.hljs-tag .hljs-string{color:var(--pre)}.hljs-comment,.hljs-keyword,.hljs-literal{color:var(--pre-dim)}.hljs-regexp,.hljs-string,.hljs-number,.hljs-tag{color:var(--pre-val)}#theme-dark{display:var(--dark)}#theme-light{display:var(--lite)}td,th{border:1px solid var(--td)}tr:hover{background:var(--tr)}.warning,.info{color:var(--warn-info)}.dl:after{background:var(--fg)}.dl:hover:after{background:var(--fg-on)}.js2 .repl-in:before,.js3 .repl-in:before{background-image:url('data:image/svg+xml,<svg width="16" height="20" xmlns="http://www.w3.org/2000/svg">  <path d="M2 5.5L6 9.5 2 13.5" stroke-width="1.5" fill="none" stroke="%237f7f7f"/>  </svg>')}.dl:after{mask-image:url('data:image/svg+xml,<svg width="22" height="22" xmlns="http://www.w3.org/2000/svg">  <path d="M11 2V15M4 8L11.7071 15.7071M18 8L10.2929 15.7071M2 19H20" stroke="black" stroke-width="2"/>  </svg>');-webkit-mask-image:url('data:image/svg+xml,<svg width="22" height="22" xmlns="http://www.w3.org/2000/svg">  <path d="M11 2V15M4 8L11.7071 15.7071M18 8L10.2929 15.7071M2 19H20" stroke="black" stroke-width="2"/>  </svg>')}</style><main><div class=index><a href=/ class=blog-logo><img src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAwIDUwMCIgd2lkdGg9IjUwMCIgaGVpZ2h0PSI1MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Yng9Imh0dHBzOi8vYm94eS1zdmcuY29tIj4KICA8cGF0aCBkPSJNIDE2NC4yMDYgMjQ5Ljc5MyBtIC00MS45NDMgMCBhIDQxLjk0MyA0MS45NDMgMCAxIDAgODMuODg2IDAgYSA0MS45NDMgNDEuOTQzIDAgMSAwIC04My44ODYgMCBaIE0gMTY0LjIwNiAyNDkuNzkzIG0gLTI1LjE2NiAwIGEgMjUuMTY2IDI1LjE2NiAwIDAgMSA1MC4zMzIgMCBhIDI1LjE2NiAyNS4xNjYgMCAwIDEgLTUwLjMzMiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjI1NjIzNCwgMC45NjY2MTUsIC0wLjk2NjYxNSwgMC4yNTYyMzQsIDI1MS44NzEwNjMsIDE3MS45NjA4NjEpIiBieDpzaGFwZT0icmluZyAxNjQuMjA2IDI0OS43OTMgMjUuMTY2IDI1LjE2NiA0MS45NDMgNDEuOTQzIDFAZGQ3ODBlYzciLz4KICA8cGF0aCBkPSJNIDE5OS4xMTggMjI3LjY2NCBtIC0xMDEuMzg2IDAgYSAxMDEuMzg2IDEwMS4zODYgMCAxIDAgMjAyLjc3MiAwIGEgMTAxLjM4NiAxMDEuMzg2IDAgMSAwIC0yMDIuNzcyIDAgWiBNIDE5OS4xMTggMjI3LjY2NCBtIC02MC44MzEgMCBhIDYwLjgzMSA2MC44MzEgMCAwIDEgMTIxLjY2MiAwIGEgNjAuODMxIDYwLjgzMSAwIDAgMSAtMTIxLjY2MiAwIFoiICB0cmFuc2Zvcm09Im1hdHJpeCgwLjkzNjQ5LCAwLjM1MDY5NSwgLTAuMzUwNjk1LCAwLjkzNjQ5LCA0MS4yMzc0MzQsIDUxLjIwMDEyNykiIGJ4OnNoYXBlPSJyaW5nIDE5OS4xMTggMjI3LjY2NCA2MC44MzEgNjAuODMxIDEwMS4zODYgMTAxLjM4NiAxQGRiZDI0ZjEyIi8+CiAgPHBhdGggZD0iTSAyMzguNDIxIDE4Mi40NjUgbSAtOTcuNDU4IDAgYSA5Ny40NTggOTcuNDU4IDAgMSAwIDE5NC45MTYgMCBhIDk3LjQ1OCA5Ny40NTggMCAxIDAgLTE5NC45MTYgMCBaIE0gMjM4LjQyMSAxODIuNDY1IG0gLTU4LjQ3MyAwIGEgNTguNDczIDU4LjQ3MyAwIDAgMSAxMTYuOTQ2IDAgYSA1OC40NzMgNTguNDczIDAgMCAxIC0xMTYuOTQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KDAuNzczNjA0LCAwLjYzMzY3LCAtMC42MzM2NywgMC43NzM2MDQsIDE4Ni40MTk0NjQsIC04MS40Nzk2ODMpIiBieDpzaGFwZT0icmluZyAyMzguNDIxIDE4Mi40NjUgNTguNDczIDU4LjQ3MyA5Ny40NTggOTcuNDU4IDFAM2ZkMjA3YzkiLz4KICA8cGF0aCBkPSJNIDI3Mi45NjQgMTk5LjAzMSBtIC0xMDAuMzgxIDAgYSAxMDAuMzgxIDEwMC4zODEgMCAxIDAgMjAwLjc2MiAwIGEgMTAwLjM4MSAxMDAuMzgxIDAgMSAwIC0yMDAuNzYyIDAgWiBNIDI3Mi45NjQgMTk5LjAzMSBtIC02MC4yMyAwIGEgNjAuMjMgNjAuMjMgMCAwIDEgMTIwLjQ2IDAgYSA2MC4yMyA2MC4yMyAwIDAgMSAtMTIwLjQ2IDAgWiIgIHRyYW5zZm9ybT0ibWF0cml4KC0wLjk5MzU3OSwgMC4xMTMxNDQsIC0wLjExMzE0NCwgLTAuOTkzNTc5LCA2NDMuMzM2MzY1LCA0MjIuODc4ODQ1KSIgYng6c2hhcGU9InJpbmcgMjcyLjk2NCAxOTkuMDMxIDYwLjIzIDYwLjIzIDEwMC4zODEgMTAwLjM4MSAxQDU2N2I5YzJjIi8+Cjwvc3ZnPg==" alt srcset></a></div><h1>Fast regular expression index with finite state transducer</h1><h2 class=author><span>March 2, 2024</span> by <span><i>Geofrey Ernest</i></span></h2><p>I needed a fast index that supports regular expressions for <a href=https://github.com/vinceanalytics/vince>vince</a>. The data model used by <code>vince</code> is append only, no deletes or updates. This means once collected the data is guaranteed not to change, so I wanted an index that will never be updated/changed, my search brought me to <a href=https://github.com/blevesearch/vellum>vellum</a> a go library implementing a FST (finite state transducer).<p>In this post I will explain how <code>vince</code> uses <code>vellum</code> to offer fast exact and regular expression search that powers property filter feature of <code>vince</code> web analytics api.<h3>Our data model</h3><pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#a6e22e>syntax</span> = <span style=color:#e6db74>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>v1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>message</span> <span style=color:#a6e22e>Data</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int64</span> <span style=color:#a6e22e>timestamp</span> = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int64</span> <span style=color:#a6e22e>id</span> = <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>optional</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>bounce</span> = <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>session</span> = <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>view</span> = <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>double</span> <span style=color:#a6e22e>duration</span> = <span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>browser</span> = <span style=color:#ae81ff>19</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>browser_version</span> = <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>city</span> = <span style=color:#ae81ff>26</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>country</span> = <span style=color:#ae81ff>23</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>device</span> = <span style=color:#ae81ff>18</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>domain</span> = <span style=color:#ae81ff>25</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>entry_page</span> = <span style=color:#ae81ff>9</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>event</span> = <span style=color:#ae81ff>7</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>exit_page</span> = <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>host</span> = <span style=color:#ae81ff>27</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>os</span> = <span style=color:#ae81ff>21</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>os_version</span> = <span style=color:#ae81ff>22</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>page</span> = <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>referrer</span> = <span style=color:#ae81ff>12</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>region</span> = <span style=color:#ae81ff>24</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>source</span> = <span style=color:#ae81ff>11</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>utm_campaign</span> = <span style=color:#ae81ff>15</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>utm_content</span> = <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>utm_medium</span> = <span style=color:#ae81ff>14</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>utm_source</span> = <span style=color:#ae81ff>13</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>utm_term</span> = <span style=color:#ae81ff>17</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>tenant_id</span> = <span style=color:#ae81ff>28</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span> <span style=color:#a6e22e>List</span> { <span style=color:#a6e22e>repeated</span> <span style=color:#a6e22e>Data</span> <span style=color:#a6e22e>items</span> = <span style=color:#ae81ff>1</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre><p>All <code>string</code> fields are referred to as properties/dimensions. They help breakdown and digest web analytics metrics. For instance, <code>Aggregate visitors by country</code>.<p>We use <code>Apache Arrow</code> for in memory representation and <code>Apache Parquet</code> for on disc (cold) storage. We keep an index for each property.<p>Data is collected in big chunks called <code>granules</code> before being stored in disc. The size of granule is configurable, by default it is <code>256MiB</code>(This is in memory size of <code>arrow.Record</code> + index) . When the granule is reached we convert it into <code>parquet</code> file with a single row group. All properties are encoded as dictionaries and all data fields/columns are compressed using <code>zstd</code>.<blockquote><p>example snippets below are approximate of the actual implementation in vince. We actually use <code>array.Dictionary</code> for property columns.</blockquote><h3>Index mapping</h3><p>Since we store the data in columns and property values are string dictionaries, for faster search we need to map between <code>value => row_id</code>, but we know that same value can appear on multiple rows so the mapping is <code>value => [row_1,row_2,row_n]</code><p>We use <code>roaring.Bitmap</code> for efficient storing/serializing of rows mapping. This is how it looks like in Go.<pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ColumnIndex</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mapping</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre><p>We can now add a method to build the mapping<pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#a6e22e>unc</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ColumnIndex</span>) <span style=color:#a6e22e>IndexProperty</span>(<span style=color:#a6e22e>prop</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>String</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>row</span> &lt; <span style=color:#a6e22e>prop</span>.<span style=color:#a6e22e>Len</span>(); <span style=color:#a6e22e>row</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prop</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bitmap</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mapping</span>[<span style=color:#a6e22e>value</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Create a new bitmap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>bitmap</span> = new(<span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mapping</span>[<span style=color:#a6e22e>value</span>] = <span style=color:#a6e22e>bitmap</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bitmap</span>.<span style=color:#a6e22e>Add</span>(uint32(<span style=color:#a6e22e>row</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre><h3>Vellum</h3><p>Now we have our mapping we can build a vellum fst from it. One challenge we have is <code>vellum</code> only accept <code>uint64</code> as values. To work around this we store <code>bitmaps</code> together with the the vellum index so we can use position of the bitmaps as value.<p>First we need to update <code>ColumnIndex</code> to store the <code>bitmaps</code> and serialized <code>vellum</code> <code>fst</code><pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ColumnIndex</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mapping</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// bitmaps positioned by sorted keys of mapping
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>values</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//serialized vellum fst
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fst</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre><p>Now, our updated index method will look like this<blockquote><p>error handling is omitted for brevity</blockquote><pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#66d9ef>func</span> (c <span style=color:#f92672>*</span>ColumnIndex) IndexProperty(prop <span style=color:#f92672>*</span>array<span style=color:#f92672>.</span>String) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> row :<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; row <span style=color:#f92672>&lt;</span> prop<span style=color:#f92672>.</span>Len(); row<span style=color:#f92672>+</span><span style=color:#f92672>+</span> {
</span></span><span style=display:flex><span>		value :<span style=color:#f92672>=</span> prop<span style=color:#f92672>.</span>Value(row)
</span></span><span style=display:flex><span>		bitmap, ok :<span style=color:#f92672>=</span> c<span style=color:#f92672>.</span>mapping[value]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>ok {
</span></span><span style=display:flex><span>			<span style=color:#f92672>/</span><span style=color:#f92672>/</span> Create a new bitmap
</span></span><span style=display:flex><span>			bitmap <span style=color:#f92672>=</span> new(roaring<span style=color:#f92672>.</span>Bitmap)
</span></span><span style=display:flex><span>			c<span style=color:#f92672>.</span>mapping[value] <span style=color:#f92672>=</span> bitmap
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		bitmap<span style=color:#f92672>.</span>Add(uint32(row))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> out bytes<span style=color:#f92672>.</span>Buffer
</span></span><span style=display:flex><span>	index, _ :<span style=color:#f92672>=</span> vellum<span style=color:#f92672>.</span>New(<span style=color:#f92672>&amp;</span>out, nil)
</span></span><span style=display:flex><span>	<span style=color:#f92672>/</span><span style=color:#f92672>/</span> vellum wants keys to be lexical sorted
</span></span><span style=display:flex><span>	keys :<span style=color:#f92672>=</span> make([]string, <span style=color:#ae81ff>0</span>, len(c<span style=color:#f92672>.</span>mapping))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> k :<span style=color:#f92672>=</span> range c<span style=color:#f92672>.</span>mapping {
</span></span><span style=display:flex><span>		keys <span style=color:#f92672>=</span> append(keys, k)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	sort<span style=color:#f92672>.</span>Strings(keys)
</span></span><span style=display:flex><span>	c<span style=color:#f92672>.</span>values <span style=color:#f92672>=</span> make([]<span style=color:#f92672>*</span>roaring<span style=color:#f92672>.</span>Bitmap, len(keys))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i, k :<span style=color:#f92672>=</span> range keys {
</span></span><span style=display:flex><span>		<span style=color:#f92672>/</span><span style=color:#f92672>/</span> store the value itmap
</span></span><span style=display:flex><span>		c<span style=color:#f92672>.</span>values[i] <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span>mapping[k]
</span></span><span style=display:flex><span>		<span style=color:#f92672>/</span><span style=color:#f92672>/</span> Note we are storing the index where the value bitmap is<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>		index<span style=color:#f92672>.</span>Insert([]byte(k), uint64(i))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	index<span style=color:#f92672>.</span>Close()
</span></span><span style=display:flex><span>	c<span style=color:#f92672>.</span>fst <span style=color:#f92672>=</span> out<span style=color:#f92672>.</span>Bytes()
</span></span><span style=display:flex><span>}
</span></span></code></pre><h3>Regular expression search</h3><p>With out <code>[]*roaring.Bitmap</code> slice and serialized <code>vellum</code> <code>fst</code> we can build our searching method. Our search goal is to find all rows which a matching term was found.<pre style=color:#f8f8f2;background-color:#272822><code><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ColumnIndex</span>) <span style=color:#a6e22e>Search</span>(<span style=color:#a6e22e>term</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// load vellum fst. Please move this out, you only need to load fst once and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// reuse it multiple times.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fst</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vellum</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fst</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// compile regex transducer using github.com/blevesearch/vellum/regexp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>regexTransducer</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>term</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>it</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fst</span>.<span style=color:#a6e22e>Search</span>(<span style=color:#a6e22e>regexTransducer</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>it</span>.<span style=color:#a6e22e>Current</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>b</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>r</span>].<span style=color:#a6e22e>Clone</span>()
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>And</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>r</span>])
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>it</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span> = new(<span style=color:#a6e22e>roaring</span>.<span style=color:#a6e22e>Bitmap</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre><p>This is all you need to introduce fast regular expression search in your Go application. Please visit <a href="https://pkg.go.dev/github.com/couchbase/vellum?utm_source=godoc">vellum documentation</a> for more details on the library and its features.</main><script>(()=>{document.body.classList.add("has-js");var t=document.getElementById("menutoggle"),n=document.getElementById("shadow"),s=document.getElementById("menu"),e=document.querySelector("nav");t.addEventListener("click",function(){s.scrollTop=0,e.classList.add("open")}),n.addEventListener("click",function(){e.classList.remove("open")})})()</script>